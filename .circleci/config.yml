version: 2.1
orbs:
  aws-ecs: circleci/aws-ecs@2.2.1
  aws-ecr: circleci/aws-ecr@7.3.0

## ALIASES ##    
production_only: &prod_only
  filters:
    branches:
      only: master
dev_only: &dev_only
  filters:
    branches:
      only: dev
test_only: &test_only
  filters:
    branches:
      only: ecs-orb-test
## COMMANDS ##
commands:
  chown_cache_dirs:
    steps:
      - run:
          command: |
            sudo chown -R circleci:circleci /usr/local/bin
            sudo chown -R circleci:circleci /home/circleci/.pyenv/versions/3.9.9/lib/python3.9/site-packages
            sudo chown -R circleci:circleci /home/circleci/.local/share/
  run_unit_tests:
      steps:
        - run:
            command: |
              mkdir test-results
              pipenv run pytest -v --junitxml=test-results/junit.xml

jobs:
  unit_tests:
    parameters:
      unit_test_img:
        description: Docker image for running unit tests
        type: string
        default: cimg/python:3.9
    working_directory: ~/app
    docker:
      - image: << parameters.unit_test_img >>
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASSWORD
        environment:
          AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
          AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
          AWS_DEFAULT_REGION: $AWS_REGION
    resource_class: small
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - chown_cache_dirs
      - restore_cache:
          key: deps9-{{ .Branch }}-{{ checksum "Pipfile.lock" }}
      - run:
          command: pipenv install
      - save_cache:
          key: deps9-{{ .Branch }}-{{ checksum "Pipfile.lock" }}
          paths:
            - ".venv"
            - "/usr/local/bin"
            - "/home/circleci/.pyenv/versions/3.9.9/lib/python3.9/site-packages"
            - "/home/circleci/.local/share/virtualenvs/"
      # - run_unit_tests
      # - store_test_results:
      #     path: test-results
  build_and_push:
    parameters:
      build_img:
        description: Docker image for building + pushing to ECR
        type: string
        default: animaldna/cimg-py-aws:latest
      target_repo:
        description: The repo to push the new image to.
        type: string
    working_directory: ~/app
    docker:
      - image: << parameters.build_img >>
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASSWORD
    resource_class: small
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - chown_cache_dirs
      - run: 
          command: aws ecr get-login-password | docker login -u ${AWS_ACCESS_KEY} AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
      - run:
          command: |
            docker build -t ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/<< parameters.target_repo >>:${CIRCLE_SHA1}-stable .
            docker push ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/<< parameters.target_repo >>:${CIRCLE_SHA1}-stable 
      #  - run:
      #     command: |
      #       docker build -t << parameters.target_repo >>:${CIRCLE_SHA1} .
      #       docker tag << parameters.target_repo >>:${CIRCLE_SHA1} ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/<< parameters.target_repo >>:${CIRCLE_SHA1}
      #       docker push ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/<< parameters.target_repo >>:${CIRCLE_SHA1} 



workflows:
  default:
    jobs:
      # - run_unit_tests:
      #     parameters:
      #       unit_test_img: cimg/python:3.9
      # - build_and_push:
      #     parameters:
      #       build_img: animaldna/cimg-py-aws:latest
      #       target_repo: 666431669894.dkr.ecr.us-east-2.amazonaws.com/cbergs-discogs
      - aws-ecr/build-and-push-image:
          <<: *test_only
          context: catalog_api_dev 
          remote-docker-layer-caching: true
          repo: catalog-api
          tag: $CIRCLE_SHA1-test
      # - aws-ecs/deploy-service-update:
      #     cluster-name: "${}-cluster"
      #     container-image-name-updates: "container=${}-service,tag=${CIRCLE_SHA1}-stable""
      #     family:
      #     requires:
      #       - aws-ecs/update-task-definition
      # - aws-ecs/verify-revision-is-deployed:
      #     cluster-name:
      #     family:
      #     task-definition
      